<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LigaApp - App de Ligas Deportivas</title>
    <!-- Cargar las librerías de React y Babel para JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Cargar la librería de Tailwind CSS desde un CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-button {
            @apply flex items-center py-2 px-4 rounded-full text-white font-medium hover:bg-white hover:bg-opacity-20 transition-colors;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // Este script ahora solo contiene el código de la aplicación.
        // Las importaciones de Firebase se manejan en el script de tipo "module" de abajo.

        const { useState, useEffect, useCallback } = React;

        // --- Componentes de Iconos ---
        const PlusIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clipRule="evenodd" />
            </svg>
        );
        const CalendarIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" />
            </svg>
        );
        const TrophyIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 6V5a1 1 0 011-1h2a1 1 0 110 2h-1v5a1 1 0 01-1 1h-2a1 1 0 01-1-1V7a1 1 0 011-1zM5 8V7a1 1 0 011-1h2a1 1 0 110 2H6v3a1 1 0 01-1 1H4a1 1 0 01-1-1V8a1 1 0 011-1h1zM10 2a8 8 0 100 16 8 8 0 000-16zM6 10a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" />
            </svg>
        );
        const EditIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                <path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
            </svg>
        );
        const TrashIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
        );
        const ChevronDownIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
            </svg>
        );
        const ChevronUpIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clipRule="evenodd" />
            </svg>
        );
        const LockIcon = ({ className = 'w-5 h-5' }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2h2a2 2 0 012 2v6a2 2 0 01-2 2H3a2 2 0 01-2-2v-6a2 2 0 012-2h2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
            </svg>
        );

        // Nombres de países en español para los equipos
        const PAISES = ['Alemania', 'Argentina', 'Australia', 'Brasil', 'Canadá', 'Chile', 'China', 'Colombia', 'Egipto', 'España', 'Estados Unidos', 'Francia', 'India', 'Italia', 'Japón', 'México', 'Nigeria', 'Países Bajos', 'Perú', 'Portugal', 'Reino Unido', 'Rusia', 'Sudáfrica', 'Turquía', 'Uruguay', 'Venezuela'];

        // Mapa de países a códigos de bandera para obtener las imágenes
        const COUNTRY_FLAGS = {
            'Alemania': 'de', 'Argentina': 'ar', 'Australia': 'au', 'Brasil': 'br', 'Canadá': 'ca', 'Chile': 'cl', 'China': 'cn',
            'Colombia': 'co', 'Egipto': 'eg', 'España': 'es', 'Estados Unidos': 'us', 'Francia': 'fr', 'India': 'in', 'Italia': 'it',
            'Japón': 'jp', 'México': 'mx', 'Nigeria': 'ng', 'Países Bajos': 'nl', 'Perú': 'pe', 'Portugal': 'pt',
            'Reino Unido': 'gb', 'Rusia': 'ru', 'Sudáfrica': 'za', 'Turquía': 'tr', 'Uruguay': 'uy', 'Venezuela': 've'
        };

        // Función para obtener la URL de la bandera
        const getFlagUrl = (countryName) => {
            const code = COUNTRY_FLAGS[countryName];
            return code ? `https://flagcdn.com/w80/${code}.png` : 'https://placehold.co/80x50/A0A0A0/FFF?text=N/A';
        };

        // --- Componente de Modal ---
        const Modal = ({ show, message, onClose }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                        <p className="text-gray-900 dark:text-white text-lg mb-4">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                        >
                            Aceptar
                        </button>
                    </div>
                </div>
            );
        };

        // --- Componente de Tabla de Clasificación ---
        const StandingsTable = ({ standings }) => {
            if (standings.length === 0) {
                return <p className="text-gray-500 dark:text-gray-400">No hay datos de clasificación para esta liga.</p>;
            }
            return (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead className="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">Equipo</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">PJ</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">G</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">E</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">P</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">GF</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">GC</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">DG</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">Pts</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {standings.map((team, index) => (
                                <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                                    <div className="flex items-center">
                                        <img src={team.flagUrl} alt={`${team.teamName} flag`} className="w-6 h-6 rounded-full mr-2" />
                                        {team.teamName}
                                    </div>
                                </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.played}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.wins}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.draws}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.losses}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.goalsFor}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.goalsAgainst}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{team.goalDifference}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">{team.points}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- Componente de Tabla de Goleadores ---
        const TopScorersTable = ({ scorers }) => {
            if (scorers.length === 0) {
                return <p className="text-gray-500 dark:text-gray-400">No hay anotadores registrados.</p>;
            }
            return (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead className="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">Jugador</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">Equipo</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 dark:text-gray-200 uppercase tracking-wider">Goles</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {scorers.map((scorer, index) => (
                                <tr key={index} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{scorer.playerName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">{scorer.teamName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">{scorer.goals}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- Componente para mostrar y editar los partidos ---
        const MatchesView = ({ matches, getTeamName, userId, appId, db, showMessage, leagues, teams, players, getLeagueName, getPlayersByTeam, selectedDateFilter, selectedLeagueFilter }) => {
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [scoreHome, setScoreHome] = useState(0);
            const [scoreAway, setScoreAway] = useState(0);
            const [scorers, setScorers] = useState([]);
            const [isEditing, setIsEditing] = useState(false);

            const handleEditMatch = (match) => {
                setSelectedMatch(match);
                setScoreHome(match.scoreHome !== null ? match.scoreHome : 0);
                setScoreAway(match.scoreAway !== null ? match.scoreAway : 0);
                setScorers(match.scorers || []);
                setIsEditing(true);
            };

            const handleSaveMatch = async () => {
                if (!selectedMatch) return;
                try {
                    const { doc, setDoc } = window.firebaseModules;
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/matches`, selectedMatch.id), {
                        ...selectedMatch,
                        scoreHome: parseInt(scoreHome, 10),
                        scoreAway: parseInt(scoreAway, 10),
                        scorers,
                    });
                    setIsEditing(false);
                    setSelectedMatch(null);
                    showMessage("Partido actualizado con éxito.");
                } catch (e) {
                    console.error("Error al guardar el partido:", e);
                    showMessage("Error al guardar el partido.");
                }
            };

            const handleAddScorer = (teamId) => {
                const newScorers = [...scorers, { playerId: '', teamId, count: 1 }];
                setScorers(newScorers);
            };

            const handleScorerChange = (index, field, value) => {
                const newScorers = [...scorers];
                newScorers[index][field] = value;
                setScorers(newScorers);
            };

            const handleRemoveScorer = (index) => {
                const newScorers = scorers.filter((_, i) => i !== index);
                setScorers(newScorers);
            };

            const filteredMatches = matches.filter(match => {
                const dateMatch = selectedDateFilter ? match.date === selectedDateFilter : true;
                const leagueMatch = selectedLeagueFilter ? match.leagueId === selectedLeagueFilter : true;
                return dateMatch && leagueMatch;
            });

            const sortedMatches = [...filteredMatches].sort((a, b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="space-y-4">
                    {isEditing && selectedMatch ? (
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                            <h4 className="text-xl font-bold">Editar Partido</h4>
                            <p className="text-gray-500 dark:text-gray-400">
                                {getLeagueName(selectedMatch.leagueId)}
                                <br />
                                {getTeamName(selectedMatch.homeTeamId)} vs {getTeamName(selectedMatch.awayTeamId)} - {selectedMatch.date}
                            </p>
                            <div className="flex items-center space-x-4">
                                <label className="text-sm font-medium">Marcador Local:</label>
                                <input
                                    type="number"
                                    min="0"
                                    value={scoreHome}
                                    onChange={(e) => setScoreHome(Math.max(0, parseInt(e.target.value, 10)))}
                                    className="w-20 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                />
                                <label className="text-sm font-medium">Marcador Visitante:</label>
                                <input
                                    type="number"
                                    min="0"
                                    value={scoreAway}
                                    onChange={(e) => setScoreAway(Math.max(0, parseInt(e.target.value, 10)))}
                                    className="w-20 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                />
                            </div>
                            <div className="space-y-2">
                                <h5 className="text-lg font-semibold">Goleadores</h5>
                                <div className="flex space-x-2">
                                    <button onClick={() => handleAddScorer(selectedMatch.homeTeamId)} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Añadir Goleador Local</button>
                                    <button onClick={() => handleAddScorer(selectedMatch.awayTeamId)} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Añadir Goleador Visitante</button>
                                </div>
                                {scorers.map((scorer, index) => (
                                    <div key={index} className="flex items-center space-x-2 bg-gray-50 dark:bg-gray-700 p-2 rounded-lg">
                                        <select
                                            value={scorer.playerId}
                                            onChange={(e) => handleScorerChange(index, 'playerId', e.target.value)}
                                            className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white flex-1"
                                        >
                                            <option value="">Selecciona un jugador</option>
                                            {getPlayersByTeam(scorer.teamId).map(p => (
                                                <option key={p.id} value={p.id}>{p.name}</option>
                                            ))}
                                        </select>
                                        <input
                                            type="number"
                                            min="1"
                                            value={scorer.count}
                                            onChange={(e) => handleScorerChange(index, 'count', parseInt(e.target.value, 10))}
                                            className="w-16 p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                        />
                                        <button onClick={() => handleRemoveScorer(index)} className="text-red-500 hover:text-red-700">
                                            <TrashIcon />
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-end space-x-2">
                                <button onClick={() => setIsEditing(false)} className="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                                <button onClick={handleSaveMatch} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">Guardar</button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {leagues.length === 0 ? (
                                <p className="text-center text-gray-500 dark:text-gray-400">No hay partidos para mostrar. Por favor, crea las ligas y genera el calendario.</p>
                            ) : (
                                sortedMatches.map(match => (
                                    <div key={match.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg flex items-center justify-between">
                                        <div>
                                            <p className="font-semibold text-lg">{getLeagueName(match.leagueId)}</p>
                                            <p className="text-gray-500 dark:text-gray-400 text-sm">{match.date}</p>
                                            <p className="text-gray-900 dark:text-white font-bold text-xl">
                                                {getTeamName(match.homeTeamId)} vs {getTeamName(match.awayTeamId)}
                                            </p>
                                            {match.scoreHome !== null && (
                                                <p className="text-indigo-600 dark:text-indigo-400 font-bold text-lg">
                                                    Marcador: {match.scoreHome} - {match.scoreAway}
                                                </p>
                                            )}
                                        </div>
                                        <button onClick={() => handleEditMatch(match)} className="text-indigo-600 hover:text-indigo-800 p-2 rounded-full transition-colors">
                                            <EditIcon />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- Componente de Tarjeta de Liga (para el panel de admin) ---
        const LeagueCard = ({ league, teams, players, userId, appId, db, showMessage }) => {
            const { useState } = React;
            const [isExpanded, setIsExpanded] = useState(false);

            const handleAddPlayer = async (teamId) => {
                const { doc, setDoc } = window.firebaseModules;
                const playerName = prompt("Introduce el nombre del jugador:");
                if (playerName) {
                    const playerId = crypto.randomUUID();
                    const newPlayer = {
                        id: playerId,
                        name: playerName,
                        teamId,
                    };
                    try {
                        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/players`, playerId), newPlayer);
                        showMessage("Jugador añadido con éxito.");
                    } catch (e) {
                        console.error("Error al añadir jugador:", e);
                        showMessage("Error al añadir jugador.");
                    }
                }
            };

            const handleDeletePlayer = async (playerId) => {
                const { doc, deleteDoc } = window.firebaseModules;
                if (confirm("¿Estás seguro de que quieres eliminar a este jugador?")) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/players`, playerId));
                        showMessage("Jugador eliminado con éxito.");
                    } catch (e) {
                        console.error("Error al eliminar jugador:", e);
                        showMessage("Error al eliminar jugador.");
                    }
                }
            };

            return (
                <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-inner">
                    <div className="flex items-center justify-between">
                        <h4 className="text-xl font-semibold text-gray-900 dark:text-white">{league.name}</h4>
                        <button onClick={() => setIsExpanded(!isExpanded)} className="text-indigo-500 hover:text-indigo-700">
                            {isExpanded ? <ChevronUpIcon /> : <ChevronDownIcon />}
                        </button>
                    </div>
                    {isExpanded && (
                        <div className="mt-4 space-y-4">
                            {teams.map(team => (
                                <div key={team.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow space-y-2">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-2">
                                            <img src={team.flagUrl} alt={`Bandera de ${team.name}`} className="w-8 h-8 rounded-full shadow-md" />
                                            <span className="font-medium">{team.name}</span>
                                        </div>
                                        <button onClick={() => handleAddPlayer(team.id)} className="text-sm bg-indigo-500 text-white py-1 px-3 rounded-full hover:bg-indigo-600 transition-colors">
                                            Añadir Jugador
                                        </button>
                                    </div>
                                    <ul className="list-disc pl-6 text-gray-600 dark:text-gray-300">
                                        {players.filter(p => p.teamId === team.id).length > 0 ? (
                                            players.filter(p => p.teamId === team.id).map(player => (
                                                <li key={player.id} className="flex items-center justify-between">
                                                    <span>{player.name}</span>
                                                    <button onClick={() => handleDeletePlayer(player.id)} className="text-red-500 hover:text-red-700">
                                                        <TrashIcon />
                                                    </button>
                                                </li>
                                            ))
                                        ) : (
                                            <li>No hay jugadores en este equipo.</li>
                                        )}
                                    </ul>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Componente principal de la aplicación ---
        const App = () => {
            const [view, setView] = useState('standings');
            const [leagues, setLeagues] = useState([]);
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [matches, setMatches] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [userId, setUserId] = useState(null);
            const [appId, setAppId] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [selectedSport, setSelectedSport] = useState('Fútbol');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [selectedDateFilter, setSelectedDateFilter] = useState('');
            const [selectedLeagueFilter, setSelectedLeagueFilter] = useState('');
            const [selectedStandingsLeagueFilter, setSelectedStandingsLeagueFilter] = useState('');
            const [reportStartDate, setReportStartDate] = useState('');
            const [reportEndDate, setReportEndDate] = useState('');
            const [refereeMatchDate, setRefereeMatchDate] = useState('');

            const ADMIN_PASSWORD = 'admin';

            const showMessage = (message) => {
                setModalMessage(message);
                setShowModal(true);
            };

            const getTeamName = useCallback((teamId) => {
                const team = teams.find(t => t.id === teamId);
                return team ? team.name : 'Equipo Desconocido';
            }, [teams]);

            const getTeamFlag = useCallback((teamId) => {
                const team = teams.find(t => t.id === teamId);
                return team ? team.flagUrl : '';
            }, [teams]);

            // useEffect para la inicialización y autenticación de Firebase
            useEffect(() => {
                const initFirebaseAndAuth = async () => {
                    try {
                        const {
                            initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged,
                            getFirestore
                        } = window.firebaseModules;

                        const firebaseConfig = {
                            apiKey: "AIzaSyBHX9ezfBiEZhxIDZTr-OTB5hgKV-zt0G4",
                            authDomain: "torneos-lasalle-2.firebaseapp.com",
                            projectId: "torneos-lasalle-2",
                            storageBucket: "torneos-lasalle-2.firebasestorage.app",
                            messagingSenderId: "860168864523",
                            appId: "1:860168864523:web:1da5a47fa8ccb20def980e"
                        };
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);

                        setAppId(currentAppId);
                        window.firebaseApp = { ...window.firebaseApp, app, auth, db: getFirestore(app) };

                        const unsubscribe = onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setIsAuthReady(true);
                                setIsLoading(false);
                            } else {
                                if (initialAuthToken) {
                                    try {
                                        await signInWithCustomToken(auth, initialAuthToken);
                                        setUserId(auth.currentUser?.uid);
                                    } catch (e) {
                                        console.error("Error signing in with custom token, signing in anonymously.", e);
                                        await signInAnonymously(auth);
                                        setUserId(auth.currentUser?.uid);
                                    }
                                } else {
                                    await signInAnonymously(auth);
                                    setUserId(auth.currentUser?.uid);
                                }
                                setIsAuthReady(true);
                                setIsLoading(false);
                            }
                        });

                        return () => unsubscribe();

                    } catch (e) {
                        console.error("Firebase no está disponible. ¿Están los scripts de Firebase cargados?", e);
                        setIsLoading(false);
                        const root = document.getElementById('root');
                        if (root) {
                            root.innerHTML = `<div class="p-8 text-center text-red-500">Error: No se pudo cargar Firebase. Por favor, revisa la conexión a internet o los scripts.</div>`;
                        }
                    }
                };

                initFirebaseAndAuth();
            }, []);

            // useEffect para los listeners de Firestore, se activa solo cuando userId y appId están listos
            useEffect(() => {
                if (!isAuthReady || !userId || !appId || !window.firebaseApp || !window.firebaseApp.db) return;

                const { getFirestore, collection, onSnapshot } = window.firebaseModules;
                const db = window.firebaseApp.db;

                const unsubscribeLeagues = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/leagues`), (snapshot) => {
                    setLeagues(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubscribeTeams = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/teams`), (snapshot) => {
                    setTeams(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubscribePlayers = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/players`), (snapshot) => {
                    setPlayers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubscribeMatches = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/matches`), (snapshot) => {
                    setMatches(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => {
                    unsubscribeLeagues();
                    unsubscribeTeams();
                    unsubscribePlayers();
                    unsubscribeMatches();
                };
            }, [userId, appId, isAuthReady]);

            const handleAdminLogin = () => {
                if (adminPassword === ADMIN_PASSWORD) {
                    setIsAuthenticated(true);
                    setAdminPassword('');
                    showMessage("Acceso de administrador concedido.");
                } else {
                    showMessage("Contraseña incorrecta. Inténtalo de nuevo.");
                    setAdminPassword('');
                }
            };

            const createLeaguesAndTeams = async () => {
                if (!userId || !appId || !window.firebaseApp || !window.firebaseApp.db) {
                    showMessage("Error: Usuario no autenticado o Firebase no disponible.");
                    return;
                }

                setIsLoading(true);
                const { db } = window.firebaseApp;
                const { collection, doc, setDoc, getDocs, query, deleteDoc } = window.firebaseModules;
                const leagueNames = ['1ro Varonil', '1ro Femenil', '3ro Varonil', '3ro Femenil', 'Areas Varonil', 'Areas Femenil'];

                try {
                    const existingLeagues = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/leagues`)));
                    existingLeagues.forEach(async (doc) => await deleteDoc(doc.ref));

                    const existingTeams = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/teams`)));
                    existingTeams.forEach(async (doc) => await deleteDoc(doc.ref));

                    const existingPlayers = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/players`)));
                    existingPlayers.forEach(async (doc) => await deleteDoc(doc.ref));

                    const existingMatches = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/matches`)));
                    existingMatches.forEach(async (doc) => await deleteDoc(doc.ref));
                } catch (e) {
                    console.error("Error al limpiar los datos existentes:", e);
                    showMessage("Error al limpiar los datos existentes.");
                    setIsLoading(false);
                    return;
                }

                const allTeams = [...PAISES];
                const shuffledTeams = allTeams.sort(() => 0.5 - Math.random());
                let teamIndex = 0;

                for (const name of leagueNames) {
                    const leagueId = crypto.randomUUID();
                    const newLeague = {
                        id: leagueId,
                        name,
                        sport: selectedSport,
                    };
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/leagues`, leagueId), newLeague);

                    const teamsInLeague = 4;
                    for (let i = 0; i < teamsInLeague; i++) {
                        const teamName = shuffledTeams[teamIndex++];
                        const teamId = crypto.randomUUID();
                        const newTeam = {
                            id: teamId,
                            name: teamName,
                            leagueId: leagueId,
                            flagUrl: getFlagUrl(teamName),
                        };
                        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/teams`, teamId), newTeam);
                    }
                }

                setIsLoading(false);
                showMessage(`Se crearon las ligas y equipos para el deporte: ${selectedSport}`);
            };

            const generateSchedule = async () => {
                if (leagues.length === 0 || teams.length === 0 || !userId || !appId || !window.firebaseApp || !window.firebaseApp.db) {
                    showMessage("Por favor, crea las ligas y equipos primero.");
                    return;
                }

                setIsLoading(true);
                const { db } = window.firebaseApp;
                const { collection, doc, setDoc, getDocs, query, deleteDoc } = window.firebaseModules;
                const matchesRef = collection(db, `artifacts/${appId}/users/${userId}/matches`);
                const newMatches = [];
                const today = new Date();

                const daysOfWeek = {
                    '1ro Varonil': 2, // Tuesday
                    '1ro Femenil': 2, // Tuesday
                    '3ro Varonil': 1, // Monday
                    '3ro Femenil': 1, // Monday
                    'Areas Varonil': 4, // Thursday
                    'Areas Femenil': 4, // Thursday
                };

                try {
                    const existingMatches = await getDocs(query(matchesRef));
                    existingMatches.forEach(async (doc) => await deleteDoc(doc.ref));
                } catch (e) {
                    console.error("Error al limpiar los partidos existentes:", e);
                    showMessage("Error al limpiar los partidos existentes.");
                    setIsLoading(false);
                    return;
                }

                leagues.forEach(league => {
                    let leagueTeams = teams.filter(team => team.leagueId === league.id);
                    if (leagueTeams.length < 2) return;

                    const hasBye = leagueTeams.length % 2 !== 0;
                    if (hasBye) {
                        leagueTeams.push({ id: 'bye', name: 'Descanso' });
                    }

                    const numTeams = leagueTeams.length;
                    const numRounds = numTeams - 1;
                    const matchesPerRound = numTeams / 2;

                    // Round-robin (ida)
                    for (let round = 0; round < numRounds; round++) {
                        let date = new Date(today);
                        const dayOffset = (daysOfWeek[league.name] - date.getDay() + 7) % 7;
                        date.setDate(date.getDate() + dayOffset + (round * 7));

                        for (let i = 0; i < matchesPerRound; i++) {
                            const homeTeam = leagueTeams[i];
                            const awayTeam = leagueTeams[numTeams - 1 - i];

                            if (homeTeam.id !== 'bye' && awayTeam.id !== 'bye') {
                                newMatches.push({
                                    id: crypto.randomUUID(),
                                    leagueId: league.id,
                                    homeTeamId: homeTeam.id,
                                    awayTeamId: awayTeam.id,
                                    date: date.toISOString().split('T')[0],
                                    scoreHome: null,
                                    scoreAway: null,
                                    scorers: [],
                                });
                            }
                        }
                        const lastTeam = leagueTeams.pop();
                        leagueTeams.splice(1, 0, lastTeam);
                    }

                    // Round-robin (vuelta)
                    leagueTeams = teams.filter(team => team.leagueId === league.id);
                    if (hasBye) {
                        leagueTeams.push({ id: 'bye', name: 'Descanso' });
                    }
                    
                    // Rearrange for the return matches
                    const teamsCopy = [...leagueTeams];
                    for (let round = 0; round < numRounds; round++) {
                        let date = new Date(today);
                        const dayOffset = (daysOfWeek[league.name] - date.getDay() + 7) % 7;
                        date.setDate(date.getDate() + dayOffset + ((round + numRounds) * 7));

                        for (let i = 0; i < matchesPerRound; i++) {
                            const homeTeam = teamsCopy[numTeams - 1 - i];
                            const awayTeam = teamsCopy[i];

                            if (homeTeam.id !== 'bye' && awayTeam.id !== 'bye') {
                                newMatches.push({
                                    id: crypto.randomUUID(),
                                    leagueId: league.id,
                                    homeTeamId: homeTeam.id,
                                    awayTeamId: awayTeam.id,
                                    date: date.toISOString().split('T')[0],
                                    scoreHome: null,
                                    scoreAway: null,
                                    scorers: [],
                                });
                            }
                        }
                        const lastTeam = teamsCopy.pop();
                        teamsCopy.splice(1, 0, lastTeam);
                    }
                });

                for (const match of newMatches) {
                    await setDoc(doc(matchesRef, match.id), match);
                }

                setIsLoading(false);
                showMessage("Calendario de ida y vuelta generado con éxito.");
            };

            const getLeagueName = (leagueId) => {
                const league = leagues.find(l => l.id === leagueId);
                return league ? league.name : 'Liga Desconocida';
            };

            const getPlayersByTeam = (teamId) => {
                return players.filter(p => p.teamId === teamId);
            };

            const calculateStandings = useCallback((leagueId) => {
                const leagueTeams = teams.filter(t => t.leagueId === leagueId);
                const leagueMatches = matches.filter(m => m.leagueId === leagueId && m.scoreHome !== null);

                const standingsMap = leagueTeams.reduce((acc, team) => {
                    acc[team.id] = { teamName: team.name, flagUrl: team.flagUrl, played: 0, wins: 0, draws: 0, losses: 0, points: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0 };
                    return acc;
                }, {});

                leagueMatches.forEach(match => {
                    const homeStats = standingsMap[match.homeTeamId];
                    const awayStats = standingsMap[match.awayTeamId];

                    if (!homeStats || !awayStats) return;

                    homeStats.played++;
                    awayStats.played++;
                    homeStats.goalsFor += match.scoreHome;
                    homeStats.goalsAgainst += match.scoreAway;
                    awayStats.goalsFor += match.scoreAway;
                    awayStats.goalsAgainst += match.scoreHome;

                    if (match.scoreHome > match.scoreAway) {
                        homeStats.wins++;
                        awayStats.losses++;
                        homeStats.points += 3;
                    } else if (match.scoreHome < match.scoreAway) {
                        awayStats.wins++;
                        homeStats.losses++;
                        awayStats.points += 3;
                    } else {
                        homeStats.draws++;
                        awayStats.draws++;
                        homeStats.points += 1;
                        awayStats.points += 1;
                    }
                    homeStats.goalDifference = homeStats.goalsFor - homeStats.goalsAgainst;
                    awayStats.goalDifference = awayStats.goalsFor - awayStats.goalsAgainst;
                });

                return Object.values(standingsMap).sort((a, b) => b.points - a.points || b.goalDifference - a.goalDifference);
            }, [teams, matches]);

            const sortLeagues = (a, b) => {
                const order = ['1ro Varonil', '1ro Femenil', '3ro Varonil', '3ro Femenil', 'Areas Varonil', 'Areas Femenil'];
                const aIndex = order.indexOf(a.name);
                const bIndex = order.indexOf(b.name);

                if (aIndex === -1 && bIndex === -1) return a.name.localeCompare(b.name); // Both not in custom order, sort alphabetically
                if (aIndex === -1) return 1; // a not in custom order, b is
                if (bIndex === -1) return -1; // b not in custom order, a is
                return aIndex - bIndex; // Both in custom order
            };

            const calculateTopScorers = useCallback((leagueId) => {
                const leagueMatches = matches.filter(m => m.leagueId === leagueId);
                const allScorers = leagueMatches.flatMap(m => m.scorers.map(s => ({ ...s, leagueId: m.leagueId })));

                const scorersMap = allScorers.reduce((acc, scorer) => {
                    const player = players.find(p => p.id === scorer.playerId);
                    if (player) {
                        if (!acc[scorer.playerId]) {
                            acc[scorer.playerId] = { playerName: player.name, teamName: getTeamName(player.teamId), goals: 0 };
                        }
                        acc[scorer.playerId].goals += scorer.count;
                    }
                    return acc;
                }, {});

                return Object.values(scorersMap).sort((a, b) => b.goals - a.goals);
            }, [players, matches, getTeamName]);

            const urlToB64 = async (url) => {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error("Error fetching image:", error);
                    return null;
                }
            };

            const generateUpcomingMatchesPdf = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageCenter = doc.internal.pageSize.getWidth() / 2;

                doc.setFontSize(22);
                doc.text("Próximos Partidos", pageCenter, 20, { align: 'center' });
                let y = 30;

                const filteredMatches = matches.filter(match => {
                    const matchDate = new Date(match.date);
                    const start = reportStartDate ? new Date(reportStartDate) : null;
                    const end = reportEndDate ? new Date(reportEndDate) : null;

                    return (!start || matchDate >= start) && (!end || matchDate <= end);
                }).sort((a, b) => new Date(a.date) - new Date(b.date));

                if (filteredMatches.length === 0) {
                    doc.setFontSize(12);
                    doc.text("No hay partidos próximos en el rango de fechas seleccionado.", pageCenter, y, { align: 'center' });
                } else {
                    for (const match of filteredMatches) {
                        if (y > 260) { // Check if page is full
                            doc.addPage();
                            y = 20;
                        }

                        const homeTeamName = getTeamName(match.homeTeamId);
                        const awayTeamName = getTeamName(match.awayTeamId);
                        const homeTeamFlagUrl = getTeamFlag(match.homeTeamId);
                        const awayTeamFlagUrl = getTeamFlag(match.awayTeamId);

                        let homeFlagB64, awayFlagB64;
                        try {
                            [homeFlagB64, awayFlagB64] = await Promise.all([
                                urlToB64(homeTeamFlagUrl),
                                urlToB64(awayTeamFlagUrl)
                            ]);
                        } catch (error) {
                            console.error("Error loading flags:", error);
                        }

                        doc.setFontSize(16);
                        doc.text(`${getLeagueName(match.leagueId)} - ${match.date}`, pageCenter, y, { align: 'center' });
                        y += 15;

                        doc.setFontSize(12);
                        if (homeFlagB64) {
                            doc.addImage(homeFlagB64, 'PNG', 40, y - 5, 10, 10);
                        }
                        doc.text(homeTeamName, 55, y);

                        doc.text("vs", pageCenter, y, { align: 'center' });

                        if (awayFlagB64) {
                            doc.addImage(awayFlagB64, 'PNG', 160, y - 5, 10, 10);
                        }
                        doc.text(awayTeamName, 145, y, { align: 'right' });

                        y += 20;
                    }
                }

                doc.save("proximos_partidos.pdf");
                showMessage("PDF de Próximos Partidos generado con éxito.");
            };

            const generateRefereeSheetPdf = async () => {
                if (!refereeMatchDate) {
                    showMessage("Por favor, selecciona una fecha para generar la cédula.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageCenter = doc.internal.pageSize.getWidth() / 2;

                const filteredMatches = matches.filter(match => match.date === refereeMatchDate);

                if (filteredMatches.length === 0) {
                    showMessage("No hay partidos para la fecha seleccionada.");
                    return;
                }

                const groupedByLeague = filteredMatches.reduce((acc, match) => {
                    (acc[match.leagueId] = acc[match.leagueId] || []).push(match);
                    return acc;
                }, {});

                let firstPage = true;
                let y = 20;

                for (const leagueId in groupedByLeague) {
                    const leagueMatches = groupedByLeague[leagueId];
                    let matchCount = 0;

                    for (const match of leagueMatches) {
                        if (matchCount % 2 === 0) {
                            if (!firstPage) {
                                doc.addPage();
                            } else {
                                firstPage = false;
                            }
                            y = 20;
                        } else {
                            y = 150;
                        }

                        doc.setFontSize(18);
                        doc.text("Cédula de Partido", pageCenter, y, { align: 'center' });
                        y += 10;

                        doc.setFontSize(12);
                        doc.text(`Liga: ${getLeagueName(match.leagueId)}`, 15, y);
                        doc.text(`Fecha: ${match.date}`, 150, y);
                        y += 15;

                        const homeTeamName = getTeamName(match.homeTeamId);
                        const awayTeamName = getTeamName(match.awayTeamId);
                        const homeTeamFlagUrl = getTeamFlag(match.homeTeamId);
                        const awayTeamFlagUrl = getTeamFlag(match.awayTeamId);
                        const homeTeamPlayers = getPlayersByTeam(match.homeTeamId).map(p => [p.name, ' ']);
                        const awayTeamPlayers = getPlayersByTeam(match.awayTeamId).map(p => [p.name, ' ']);

                        let homeFlagB64, awayFlagB64;
                        try {
                            [homeFlagB64, awayFlagB64] = await Promise.all([
                                urlToB64(homeTeamFlagUrl),
                                urlToB64(awayTeamFlagUrl)
                            ]);
                        } catch (error) {
                            console.error("Error loading flags:", error);
                        }

                        if (homeFlagB64) {
                            doc.addImage(homeFlagB64, 'PNG', 15, y - 5, 10, 10);
                        }
                        doc.autoTable({
                            startY: y + 5,
                            head: [[homeTeamName, 'N']],
                            body: homeTeamPlayers,
                            theme: 'grid',
                            margin: { left: 15 },
                            tableWidth: 85,
                        });

                        if (awayFlagB64) {
                            doc.addImage(awayFlagB64, 'PNG', 105, y - 5, 10, 10);
                        }
                        doc.autoTable({
                            startY: y + 5,
                            head: [[awayTeamName, 'N']],
                            body: awayTeamPlayers,
                            theme: 'grid',
                            margin: { left: 105 },
                            tableWidth: 85,
                        });

                        y = doc.autoTable.previous.finalY + 10;

                        doc.text("Marcador Final:", pageCenter, y, { align: 'center' });
                        y += 5;
                        doc.rect(pageCenter - 20, y, 40, 10);
                        y += 20;

                        doc.text("Observaciones:", 15, y);
                        y += 5;
                        doc.rect(15, y, 180, 15);
                        y += 25;

                        doc.line(30, y, 90, y);
                        doc.text("Firma Árbitro", 45, y + 5);

                        doc.line(120, y, 180, y);
                        doc.text("Firma Capitán Local", 130, y + 5);

                        matchCount++;
                    }
                }

                doc.save(`cedula_arbitro_${refereeMatchDate}.pdf`);
                showMessage("Cédula de Árbitro generada con éxito.");
            };

            const generateStandingsAndTopScorersPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;

                leagues.sort(sortLeagues).forEach(league => {
                    doc.text(`Liga: ${league.name}`, 10, y);
                    y += 10;

                    // Standings
                    doc.text("Clasificación:", 15, y);
                    y += 7;
                    const standings = calculateStandings(league.id);
                    if (standings.length === 0) {
                        doc.text("No hay datos de clasificación.", 20, y);
                        y += 10;
                    } else {
                        // Headers
                        doc.text("Equipo", 20, y);
                        doc.text("PJ", 60, y);
                        doc.text("G", 75, y);
                        doc.text("E", 90, y);
                        doc.text("P", 105, y);
                        doc.text("GF", 120, y);
                        doc.text("GC", 135, y);
                        doc.text("DG", 150, y);
                        doc.text("Pts", 165, y);
                        y += 5;
                        doc.line(15, y, 180, y); // Underline
                        y += 5;

                        standings.forEach(team => {
                            doc.text(team.teamName, 20, y);
                            doc.text(String(team.played), 60, y);
                            doc.text(String(team.wins), 75, y);
                            doc.text(String(team.draws), 90, y);
                            doc.text(String(team.losses), 105, y);
                            doc.text(String(team.goalsFor), 120, y);
                            doc.text(String(team.goalsAgainst), 135, y);
                            doc.text(String(team.goalDifference), 150, y);
                            doc.text(String(team.points), 165, y);
                            y += 7;
                            if (y > 280) {
                                doc.addPage();
                                y = 10;
                                doc.text(`Liga: ${league.name} (cont.)`, 10, y);
                                y += 10;
                                doc.text("Clasificación:", 15, y);
                                y += 7;
                                doc.text("Equipo", 20, y);
                                doc.text("PJ", 60, y);
                                doc.text("G", 75, y);
                                doc.text("E", 90, y);
                                doc.text("P", 105, y);
                                doc.text("GF", 120, y);
                                doc.text("GC", 135, y);
                                doc.text("DG", 150, y);
                                doc.text("Pts", 165, y);
                                y += 5;
                                doc.line(15, y, 180, y);
                                y += 5;
                            }
                        });
                    }
                    y += 10;

                    // Top Scorers
                    doc.text("Tabla de Anotadores:", 15, y);
                    y += 7;
                    const scorers = calculateTopScorers(league.id);
                    if (scorers.length === 0) {
                        doc.text("No hay anotadores registrados.", 20, y);
                        y += 10;
                    } else {
                        // Headers
                        doc.text("Jugador", 20, y);
                        doc.text("Equipo", 80, y);
                        doc.text("Goles", 140, y);
                        y += 5;
                        doc.line(15, y, 180, y); // Underline
                        y += 5;

                        scorers.forEach(scorer => {
                            doc.text(scorer.playerName, 20, y);
                            doc.text(scorer.teamName, 80, y);
                            doc.text(String(scorer.goals), 140, y);
                            y += 7;
                            if (y > 280) {
                                doc.addPage();
                                y = 10;
                                doc.text(`Liga: ${league.name} (cont.)`, 10, y);
                                y += 10;
                                doc.text("Tabla de Anotadores:", 15, y);
                                y += 7;
                                doc.text("Jugador", 20, y);
                                doc.text("Equipo", 80, y);
                                doc.text("Goles", 140, y);
                                y += 5;
                                doc.line(15, y, 180, y);
                                y += 5;
                            }
                        });
                    }
                    y += 15; // Space after each league's reports

                    if (y > 280) { // Ensure new page if content overflows
                        doc.addPage();
                        y = 10;
                    }
                });

                doc.save("clasificacion_y_goleadores.pdf");
                showMessage("PDF de Clasificación y Goleadores generado con éxito.");
            };

            const renderAdminPanel = () => (
                <div className="p-4 space-y-6">
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-4">Panel de Administración</h2>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Crear Ligas y Equipos</h3>
                        <p className="text-gray-600 dark:text-gray-300">Esto eliminará todos los datos existentes y creará un nuevo conjunto de ligas, equipos y jugadores.</p>
                        <div className="flex items-center space-x-4">
                            <div className="relative">
                                <select
                                    id="sport-select"
                                    value={selectedSport}
                                    onChange={(e) => setSelectedSport(e.target.value)}
                                    className="w-full p-3 pl-10 pr-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white transition-colors"
                                >
                                    {['Fútbol', 'Básquetbol', 'Tocho', 'Voleibol'].map(sport => (
                                        <option key={sport} value={sport}>{sport}</option>
                                    ))}
                                </select>
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-2xl">
                                    {selectedSport === 'Fútbol' && '⚽️'}
                                    {selectedSport === 'Básquetbol' && '🏀'}
                                    {selectedSport === 'Tocho' && '🏈'}
                                    {selectedSport === 'Voleibol' && '🏐'}
                                </div>
                            </div>
                            <button
                                onClick={createLeaguesAndTeams}
                                className="py-3 px-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold rounded-xl shadow-lg transform transition-transform duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            >
                                <PlusIcon className="inline-block w-5 h-5 mr-2" />
                                Crear Ligas
                            </button>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Gestión de Ligas y Equipos</h3>
                        {leagues.length === 0 ? (
                            <p className="text-center text-gray-500 dark:text-gray-400">Aún no hay ligas creadas.</p>
                        ) : (
                            leagues.map(league => (
                                <LeagueCard
                                    key={league.id}
                                    league={league}
                                    teams={teams.filter(t => t.leagueId === league.id)}
                                    players={players}
                                    userId={userId}
                                    appId={appId}
                                    db={window.firebaseApp.db}
                                    showMessage={showMessage}
                                />
                            ))
                        )}
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Generar Calendario</h3>
                        <p className="text-gray-600 dark:text-gray-300">Genera el calendario de partidos para todas las ligas existentes. Esto eliminará los partidos anteriores.</p>
                        <button
                            onClick={generateSchedule}
                            className="py-2 px-4 bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-bold rounded-xl shadow-lg transform transition-transform duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
                        >
                            <CalendarIcon className="inline-block w-5 h-5 mr-2" />
                            Generar Calendario
                        </button>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Informes</h3>
                        <p className="text-gray-600 dark:text-gray-300">Generar informes en PDF.</p>
                        <div className="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha Inicio:</label>
                            <input
                                type="date"
                                value={reportStartDate}
                                onChange={(e) => setReportStartDate(e.target.value)}
                                className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha Fin:</label>
                            <input
                                type="date"
                                value={reportEndDate}
                                onChange={(e) => setReportEndDate(e.target.value)}
                                className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                        </div>
                        <div className="flex space-x-4">
                            <button
                                onClick={generateUpcomingMatchesPdf}
                                className="py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition-colors"
                            >
                                PDF Próximos Partidos
                            </button>
                            <button
                                onClick={generateStandingsAndTopScorersPdf}
                                className="py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg transition-colors"
                            >
                                PDF Clasificación y Goleadores
                            </button>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Cédula de Partidos para el Árbitro</h3>
                        <p className="text-gray-600 dark:text-gray-300">Generar una cédula de partidos para una fecha específica.</p>
                        <div className="flex items-center space-x-4">
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Fecha del Partido:</label>
                            <input
                                type="date"
                                value={refereeMatchDate}
                                onChange={(e) => setRefereeMatchDate(e.target.value)}
                                className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                            <button
                                onClick={generateRefereeSheetPdf}
                                className="py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-colors"
                            >
                                Generar Cédula
                            </button>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">Registro de Partidos</h3>
                        <div className="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                            <input
                                type="date"
                                value={selectedDateFilter}
                                onChange={(e) => setSelectedDateFilter(e.target.value)}
                                className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                            <select
                                value={selectedLeagueFilter}
                                onChange={(e) => setSelectedLeagueFilter(e.target.value)}
                                className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                            >
                                <option value="">Todas las Ligas</option>
                                {leagues.sort(sortLeagues).map(league => (
                                    <option key={league.id} value={league.id}>{league.name}</option>
                                ))}
                            </select>
                        </div>
                        <MatchesView
                            matches={matches}
                            leagues={leagues}
                            teams={teams}
                            players={players}
                            getLeagueName={getLeagueName}
                            getTeamName={getTeamName}
                            getPlayersByTeam={getPlayersByTeam}
                            userId={userId}
                            appId={appId}
                            db={window.firebaseApp.db}
                            showMessage={showMessage}
                            selectedDateFilter={selectedDateFilter}
                            selectedLeagueFilter={selectedLeagueFilter}
                        />
                    </div>
                </div>
            );

            const renderStandings = () => (
                <div className="p-4 space-y-6">
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-4">Clasificaciones y Anotadores</h2>
                    <div className="mb-4">
                        <select
                            value={selectedStandingsLeagueFilter}
                            onChange={(e) => setSelectedStandingsLeagueFilter(e.target.value)}
                            className="p-2 rounded-lg border dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                            <option value="">Todas las Ligas</option>
                            {leagues.sort(sortLeagues).map(league => (
                                <option key={league.id} value={league.id}>{league.name}</option>
                            ))}
                        </select>
                    </div>
                    {leagues.length === 0 ? (
                        <p className="text-center text-gray-500 dark:text-gray-400">No hay ligas para mostrar las clasificaciones. Por favor, pídele a un administrador que cree las ligas.</p>
                    ) : (
                        leagues
                            .filter(league => selectedStandingsLeagueFilter ? league.id === selectedStandingsLeagueFilter : true)
                            .sort(sortLeagues) // Apply sorting here
                            .map(league => (
                                <div key={league.id} className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                                    <h3 className="text-2xl font-semibold text-gray-900 dark:text-white">{league.name}</h3>
                                    <div className="flex flex-col md:flex-row md:space-x-6 space-y-6 md:space-y-0">
                                        <div className="flex-1">
                                            <h4 className="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2">Clasificación</h4>
                                            <StandingsTable standings={calculateStandings(league.id)} />
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2">Tabla de Anotadores</h4>
                                            <TopScorersTable scorers={calculateTopScorers(league.id)} />
                                        </div>
                                    </div>
                                </div>
                            ))
                    )}
                </div>
            );

            const renderView = () => {
                if (isLoading) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
                            <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-indigo-500"></div>
                            <p className="ml-4 text-indigo-500 text-lg">Cargando...</p>
                        </div>
                    );
                }
                switch (view) {
                    case 'standings':
                        return renderStandings();
                    case 'admin':
                        return isAuthenticated ? renderAdminPanel() : (
                            <div className="flex items-center justify-center h-[50vh]">
                                <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
                                    <h3 className="text-2xl font-bold mb-4">Acceso de Administrador</h3>
                                    <p className="text-gray-600 dark:text-gray-300 mb-4">Por favor, introduce la contraseña para acceder al panel de administración.</p>
                                    <input
                                        type="password"
                                        value={adminPassword}
                                        onChange={(e) => setAdminPassword(e.target.value)}
                                        onKeyDown={(e) => { if (e.key === 'Enter') handleAdminLogin(); }}
                                        className="w-full p-3 mb-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                                        placeholder="Contraseña"
                                    />
                                    <button
                                        onClick={handleAdminLogin}
                                        className="w-full py-3 px-6 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-xl transition-colors"
                                    >
                                        Ingresar
                                    </button>
                                </div>
                            </div>
                        );
                    default:
                        return renderStandings();
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
                    <nav className="bg-indigo-700 dark:bg-indigo-800 p-4 shadow-lg sticky top-0 z-50">
                        <div className="flex justify-between items-center max-w-7xl mx-auto">
                            <span className="text-white font-bold text-xl">LigaApp</span>
                            <div className="flex items-center space-x-4">
                                <button onClick={() => setView('standings')} className="nav-button">
                                    <TrophyIcon className="inline-block w-5 h-5 mr-2" />
                                    Clasificación
                                </button>
                                <button onClick={() => setView('admin')} className="nav-button">
                                    <LockIcon className="inline-block w-5 h-5 mr-2" />
                                    Administrador
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto py-6">
                        {renderView()}
                    </main>

                    <Modal show={showModal} message={modalMessage} onClose={() => setShowModal(false)} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <!-- Cargar los módulos de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Exportar los módulos a la ventana global para que puedan ser usados en el script de tipo "text/babel"
        window.firebaseModules = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
        };
    </script>
</body>
</html>